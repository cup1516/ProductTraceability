<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pt.ptdealerproc.mapper.ProcProcessMapper">

    <resultMap id="BaseResultMap" type="com.pt.ptdealerproc.dto.ProcessDto">
                  <id  column="process_id" property="processId"/>
						<result column="company_id" property="companyId" />
                        <result column="process_code" property="processCode" />
                        <result  column="process_name" property="processName"/>
					    <result  column="create_time" property="createTime"/>
					    <result  column="update_time" property="updateTime"/>
						<result  column="create_by" property="createBy"/>
						<result  column="remark" property="remark"/>
						<result  column="status" property="status"/>
						<result  column="check_status" property="checkStatus"/>
				  <collection property="processNodes" ofType="com.pt.ptdealerproc.dto.NodeDto"
							  select="com.pt.ptdealerproc.mapper.ProcProcessNodeMapper.listProcessNode" column="{processId=process_id,companyId = company_id}"  >
				  </collection>
    </resultMap>
	

	<sql id="selectProcProcess">
			select p.process_id,p.company_id, p.process_code,p.process_name,p.status,u.nick_name as create_by,p.create_time,p.remark,p.check_status
			from dealer_process p
			left join system_user  u on u.user_name = p.create_by and u.company_id = p.company_id
	</sql>
	
	<select id="getProcessDtoPage" resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		<where>
			p.del_flag = '0' and p.company_id = #{companyId}
			<if test="query.processCode != null and query.processCode != ''">
				AND p.process_code like concat('%', #{query.processCode}, '%')
			</if>
			<if test="query.processName != null and query.processName != ''">
				AND p.process_name like concat('%', #{query.processName}, '%')
			</if>
			<if test="query.status != null and query.status != ''">
				AND p.status = #{query.status}
			</if>
			<if test="query.checkStatus != null and query.checkStatus != ''">
				AND p.check_status = #{query.checkStatus}
			</if>
			<if test="query.createBy != null and query.createBy != ''">
				AND p.create_by = #{query.createBy}
			</if>
		</where>
		ORDER BY p.create_time DESC
	</select>
	<select id="getProcessDtoCheckPage" resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		<where>
			p.del_flag = '0' and p.check_status = '1' and p.company_id = #{companyId}
			<if test="query.processCode != null and query.processCode != ''">
				AND p.process_code like concat('%', #{query.processCode}, '%')
			</if>
			<if test="query.processName != null and query.processName != ''">
				AND p.process_name like concat('%', #{query.processName}, '%')
			</if>
			<if test="query.createBy != null and query.createBy != ''">
				AND p.create_by = #{query.createBy}
			</if>
		</where>
		ORDER BY p.create_time DESC
	</select>

	<select id="getProcProcessList" resultMap="BaseResultMap">
		select p.process_id, p.process_code,p.process_name
		from dealer_process p
		<where>
			p.del_flag = '0' and p.status = '0' and p.company_id = #{companyId}
		</where>
		ORDER BY p.process_code ASC
	</select>

	<select id="selectProcessList" resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		<where>
			company_id = #{companyId}
			<if test="process.processCode != null and process.processCode != ''">
				AND process_code like concat('%', #{process.processCode}, '%')
			</if>
			<if test="process.status != null and process.status != ''">
				AND status = #{process.status}
			</if>
			<if test="process.processName != null and process.processName != ''">
				AND process_name like concat('%', #{process.processName}, '%')
			</if>
		</where>
	</select>

	<select id="selectProcessAll" resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		where p.company_id = #{companyId}
	</select>

	<select id="selectProcessById"  resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		where p.process_id = #{processId} and p.company_id = #{companyId}
	</select>

	<select id="checkProcessNameUnique"  resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		where p.process_name=#{processName} and p.company_id = #{companyId}
	</select>

	<select id="checkProcessCodeUnique"  resultMap="BaseResultMap">
		<include refid="selectProcProcess"/>
		where p.process_code=#{processCode} and p.company_id = #{companyId}
	</select>

	<update id="updateProcess" >
		update dealer_process
		<set>
			<if test="process.processCode != null and process.processCode != ''">process_code = #{process.processCode},</if>
			<if test="process.processName != null and process.processName != ''">process_name = #{process.processName},</if>
			<if test="process.status != null and process.status != ''">status = #{process.status},</if>
			<if test="process.remark != null">remark = #{process.remark},</if>
		</set>
		where process_id = #{process.processId} and company_id = #{companyId}
	</update>

	<insert id="insertProcess"  keyProperty="processId">
		insert into dealer_process(
		<if test="process.processId != null and process.processId != ''">process_id,</if>
		<if test="companyId != null and companyId != ''">company_id,</if>
		<if test="process.processCode != null and process.processCode != ''">process_code,</if>
		<if test="process.processName != null and process.processName != ''">process_name,</if>
		<if test="process.status != null and process.status != ''">status,</if>
		<if test="process.remark != null and process.remark != ''">remark,</if>
		<if test="process.createBy != null and process.createBy != ''">create_by,</if>
		create_time
		)values(
		<if test="process.processId != null and process.processId != ''">#{process.processId},</if>
		<if test="companyId != null and companyId != ''">#{companyId},</if>
		<if test="process.processCode != null and process.processCode != ''">#{process.processCode},</if>
		<if test="process.processName != null and process.processName != ''">#{process.processName},</if>
		<if test="process.status != null and process.status != ''">#{process.status},</if>
		<if test="process.remark != null and process.remark != ''">#{process.remark},</if>
		<if test="process.createBy != null and process.createBy != ''">#{process.createBy},</if>
		sysdate()
		)
	</insert>

	<delete id="deleteProcessById" >
		delete from dealer_process where process_id = #{processId} and company_id = #{companyId}
	</delete>

	<delete id="deleteProcessByIds" >
		delete from dealer_process where company_id = #{companyId} and process_id in
		<foreach collection="processIds" item="processId" open="(" separator="," close=")">
			#{processId}
		</foreach>
	</delete>
	<update id="changeCheckStatus">
		update dealer_process p
		<set>
			p.check_status= #{processDto.checkStatus}
		</set>
		where p.process_id = #{processDto.processId} and company_id = #{companyId}
	</update>
</mapper>
